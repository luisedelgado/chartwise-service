services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"  # Expose the internal port 8080 and map it to host port 8080
      - "5678:5678"  # Expose the debugger port
    environment:
      PYTHONUNBUFFERED: "True"
      APP_HOME: "/app"
      DEBUG_MODE: "true"
    env_file:
      - .env
    volumes:
      - .:/app  # Mount the current directory into the container
    command: "python3 -Xfrozen_modules=off -m uvicorn app.main:app --host 0.0.0.0 --port 8080"
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: "2g"
    restart: always  # Ensure the service is restarted on failure

  pending_audio_jobs_script:
    build:
      context: .
      dockerfile: scripts/pending_audio_jobs_script.Dockerfile
    ports:
      - "5679:5679"
    environment:
      PYTHONUNBUFFERED: "True"
      APP_HOME: "/app"
    env_file:
      - .env
    volumes:
      - .:/app
    depends_on:
      - app
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: "512m"
    command: "python3 -Xfrozen_modules=off -m debugpy --listen 0.0.0.0:5679 --wait-for-client /app/scripts/process_pending_jobs.py"

# Running command:
# docker-compose up --build
